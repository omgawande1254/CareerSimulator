CREATE DATABASE IF NOT EXISTS library;
USE library;

-- Borrower Table
CREATE TABLE Borrower (
    Roll_no INT PRIMARY KEY,
    Name VARCHAR(50),
    DateOfIssue DATE,
    NameOfBook VARCHAR(100),
    Status CHAR(1) CHECK (Status IN ('I', 'R'))
);

-- Fine Table
CREATE TABLE Fine (
    FineID INT AUTO_INCREMENT PRIMARY KEY,
    Roll_no INT,
    Date_ DATE,
    Amt DECIMAL(10,2),
    FOREIGN KEY (Roll_no) REFERENCES Borrower(Roll_no)
);
INSERT INTO Borrower VALUES
(101, 'Om Gawande', '2025-10-01', 'DBMS', 'I'),
(102, 'Raj Mehta', '2025-10-25', 'CN', 'I'),
(103, 'Neha Sharma', '2025-10-10', 'OS', 'R');
DELIMITER $$

CREATE PROCEDURE ReturnBook(
    IN p_roll_no INT,
    IN p_book VARCHAR(100)
)
BEGIN
    DECLARE v_dateofissue DATE;
    DECLARE v_status CHAR(1);
    DECLARE v_days INT;
    DECLARE v_fine DECIMAL(10,2) DEFAULT 0;
    DECLARE done INT DEFAULT 0;

    -- Exception handler if no record found
    DECLARE CONTINUE HANDLER FOR NOT FOUND
    BEGIN
        SET done = 1;
    END;

    -- Get date and status
    SELECT DateOfIssue, Status
    INTO v_dateofissue, v_status
    FROM Borrower
    WHERE Roll_no = p_roll_no AND NameOfBook = p_book;

    IF done = 1 THEN
        SELECT CONCAT('❌ No record found for Roll No ', p_roll_no, ' and book ', p_book) AS Message;
    ELSE
        -- Check if already returned
        IF v_status = 'R' THEN
            SELECT CONCAT('⚠️ Book "', p_book, '" already returned.') AS Message;
        ELSE
            SET v_days = DATEDIFF(CURDATE(), v_dateofissue);

            -- Fine calculation
            IF v_days BETWEEN 15 AND 30 THEN
                SET v_fine = v_days * 5;
            ELSEIF v_days > 30 THEN
                SET v_fine = (30 * 5) + ((v_days - 30) * 50);
            ELSE
                SET v_fine = 0;
            END IF;

            -- Update borrower status
            UPDATE Borrower
            SET Status = 'R'
            WHERE Roll_no = p_roll_no AND NameOfBook = p_book;

            -- Insert fine if applicable
            IF v_fine > 0 THEN
                INSERT INTO Fine (Roll_no, Date_, Amt)
                VALUES (p_roll_no, CURDATE(), v_fine);
                SELECT CONCAT('✅ Book returned. Fine = Rs ', v_fine) AS Message;
            ELSE
                SELECT '✅ Book returned. No fine applicable.' AS Message;
            END IF;
        END IF;
    END IF;
END$$

DELIMITER ;
CALL ReturnBook(101, 'DBMS');
CALL ReturnBook(102, 'CN');
CALL ReturnBook(103, 'OS');
SELECT * FROM Borrower;
SELECT * FROM Fine;
