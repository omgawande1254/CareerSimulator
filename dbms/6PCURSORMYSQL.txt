CREATE DATABASE IF NOT EXISTS school;
USE school;

-- Drop old tables if they exist
DROP TABLE IF EXISTS O_RollCall;
DROP TABLE IF EXISTS N_RollCall;

-- Create tables
CREATE TABLE O_RollCall (
    Roll_No INT PRIMARY KEY,
    Name VARCHAR(50)
);

CREATE TABLE N_RollCall (
    Roll_No INT PRIMARY KEY,
    Name VARCHAR(50)
);


-- Old Roll Call data
INSERT INTO O_RollCall VALUES (1, 'Om Gawande');
INSERT INTO O_RollCall VALUES (2, 'Raj Mehta');
INSERT INTO O_RollCall VALUES (3, 'Neha Sharma');

-- New Roll Call data (includes one duplicate)
INSERT INTO N_RollCall VALUES (3, 'Neha Sharma');
INSERT INTO N_RollCall VALUES (4, 'Aditi Patil');
INSERT INTO N_RollCall VALUES (5, 'Vikas Rao');


DELIMITER $$

CREATE PROCEDURE Merge_RollCall()
BEGIN
    DECLARE done INT DEFAULT 0;
    DECLARE v_roll INT;
    DECLARE v_name VARCHAR(50);
    DECLARE v_exists INT;

    -- Cursor for all records in N_RollCall
    DECLARE cur_new CURSOR FOR SELECT Roll_No, Name FROM N_RollCall;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

    OPEN cur_new;

    read_loop: LOOP
        FETCH cur_new INTO v_roll, v_name;
        IF done = 1 THEN
            LEAVE read_loop;
        END IF;

        -- Check if Roll_No already exists in O_RollCall
        SELECT COUNT(*) INTO v_exists FROM O_RollCall WHERE Roll_No = v_roll;

        -- If not exists, insert into O_RollCall
        IF v_exists = 0 THEN
            INSERT INTO O_RollCall (Roll_No, Name) VALUES (v_roll, v_name);
        END IF;
    END LOOP;

    CLOSE cur_new;
END$$

DELIMITER ;


CALL Merge_RollCall();


SELECT * FROM O_RollCall;
